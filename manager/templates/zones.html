{% extends "layout.html" %}

{% block title %}钓鱼区域管理{% endblock %}

{% block extra_css %}
<style>
.fish-list-toggle {
    transition: all 0.3s ease;
}

.fish-list-toggle .fa-chevron-down {
    transition: transform 0.3s ease;
}

.fish-list-toggle[aria-expanded="true"] .fa-chevron-down {
    transform: rotate(180deg);
}

.collapse {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>钓鱼区域管理</h2>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createZoneModal">
            <i class="fas fa-plus"></i> 创建新区域
        </button>
    </div>
    <p>管理游戏中的钓鱼区域。您可以创建、编辑、删除区域，并配置每个区域的详细参数。</p>

    <div id="zones-list">
        {% for zone in zones %}
        <div class="card mb-4" id="zone-card-{{ zone.id }}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ zone.name }} (ID: {{ zone.id }})</h4>
                <div>
                    <button class="btn btn-sm btn-primary me-2" onclick="openEditModal({{ zone.id }})"><i class="fas fa-edit"></i> 编辑</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteZone({{ zone.id }})"><i class="fas fa-trash"></i> 删除</button>
                </div>
            </div>
            <div class="card-body">
                <p><strong>描述:</strong> {{ zone.description }}</p>
                <p><strong>状态:</strong> 
                    <span class="badge bg-{{ 'success' if zone.is_active else 'secondary' }}">
                        {{ '启用' if zone.is_active else '禁用' }}
                    </span>
                </p>
                {% if zone.available_from or zone.available_until %}
                <p><strong>开放时间:</strong> 
                    {{ zone.available_from if zone.available_from else '不限' }} - 
                    {{ zone.available_until if zone.available_until else '不限' }}
                </p>
                {% endif %}
                <p><strong>稀有鱼每日配额:</strong> {{ zone.daily_rare_fish_quota }}</p>
                <p><strong>钓鱼消耗:</strong> {{ zone.fishing_cost }} 金币</p>
                {% if zone.requires_pass and zone.required_item_id %}
                <p><strong>通行证要求:</strong> 
                    <span class="badge bg-warning">
                        {% for item in all_items if item.item_id == zone.required_item_id %}
                            {{ item.name }}
                        {% endfor %}
                    </span>
                </p>
                {% else %}
                <p><strong>通行证要求:</strong> <span class="badge bg-success">无需通行证</span></p>
                {% endif %}
                <div><strong>限定鱼类 ({{ zone.specific_fish_ids|length }}):</strong>
                    {% if zone.specific_fish_ids|length > 0 %}
                        {% if zone.specific_fish_ids|length <= 5 %}
                            <ul class="list-group list-group-flush">
                                {% for fish_id in zone.specific_fish_ids %}
                                    {% for fish in all_fish if fish.fish_id == fish_id %}
                                        <li class="list-group-item">{{ fish.name }} (ID: {{ fish.fish_id }})</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-secondary fish-list-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#fishList{{ zone.zone_id }}" aria-expanded="false" aria-controls="fishList{{ zone.zone_id }}">
                                    <i class="fas fa-chevron-down"></i> 查看全部 {{ zone.specific_fish_ids|length }} 种鱼类
                                </button>
                                <div class="collapse mt-2" id="fishList{{ zone.zone_id }}">
                                    <ul class="list-group list-group-flush">
                                        {% for fish_id in zone.specific_fish_ids %}
                                            {% for fish in all_fish if fish.fish_id == fish_id %}
                                                <li class="list-group-item">{{ fish.name }} (ID: {{ fish.fish_id }})</li>
                                            {% endfor %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">无 (使用全局鱼池)</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Create Zone Modal -->
<div class="modal fade" id="createZoneModal" tabindex="-1" aria-labelledby="createZoneModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createZoneModalLabel">创建新区域</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Form content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Zone Modal -->
<div class="modal fade" id="editZoneModal" tabindex="-1" aria-labelledby="editZoneModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editZoneModalLabel">编辑区域</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editZoneModalBody">
                <!-- Form content will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const zonesData = {{ zones|tojson }};
    const allFishData = {{ all_fish|tojson }};
    const allItemsData = {{ all_items|tojson }};

    function getZoneById(zoneId) {
        return zonesData.find(z => z.id === zoneId);
    }

    function renderForm(zone = null) {
        const isEdit = zone !== null;
        const rarityDistribution = zone?.configs?.rarity_distribution || [0.5, 0.3, 0.15, 0.04, 0.01, 0];
        // 确保稀有度分布数组长度为6（1-5星 + 6+星）
        while (rarityDistribution.length < 6) {
            rarityDistribution.push(0);
        }
        const specificFishIds = zone?.specific_fish_ids || [];

        // 按稀有度分组鱼类
        const fishByRarity = {};
        allFishData.forEach(fish => {
            if (!fishByRarity[fish.rarity]) {
                fishByRarity[fish.rarity] = [];
            }
            fishByRarity[fish.rarity].push(fish);
        });
        
        // 生成总鱼池HTML
        let totalFishListHtml = '';
        for (let rarity = 1; rarity <= 10; rarity++) {
            if (fishByRarity[rarity] && fishByRarity[rarity].length > 0) {
                const rarityStars = '★'.repeat(rarity);
                const availableCount = fishByRarity[rarity].filter(fish => !specificFishIds.includes(fish.fish_id)).length;
                totalFishListHtml += `
                    <div class="list-group-item bg-light fw-bold d-flex justify-content-between align-items-center">
                        <span>${rarityStars} ${rarity}星鱼类 (${fishByRarity[rarity].length}种)</span>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rarity-${rarity}" onchange="toggleRaritySelection(${rarity})" title="选中/取消选中此星级所有鱼类">
                            <label class="form-check-label" for="rarity-${rarity}">
                                全选
                            </label>
                        </div>
                    </div>
                `;
                fishByRarity[rarity].forEach(fish => {
                    const value = fish.base_value.toLocaleString();
                    const isSelected = specificFishIds.includes(fish.fish_id);
                    totalFishListHtml += `
                        <div class="list-group-item fish-item ${isSelected ? 'd-none' : ''}" 
                             data-fish-id="${fish.fish_id}" 
                             data-rarity="${fish.rarity}" 
                             data-value="${fish.base_value}"
                             data-name="${fish.name}"
                             ondblclick="addFishToSelected(${fish.fish_id})"
                             onclick="toggleFishSelection(this)">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${fish.name}</strong>
                                    <br><small class="text-muted">价值: ${value} 金币</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="${fish.fish_id}">
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        return `
            <form id="${isEdit ? 'edit' : 'create'}-zone-form">
                <div class="alert alert-danger d-none" role="alert" id="form-error-alert"></div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="id" class="form-label">区域 ID</label>
                        <input type="number" class="form-control" name="id" value="${zone?.id || ''}" ${isEdit ? 'readonly' : ''} required>
                    </div>
                    <div class="col-md-9 mb-3">
                        <label for="name" class="form-label">区域名称</label>
                        <input type="text" class="form-control" name="name" value="${zone?.name || ''}" required>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">描述</label>
                    <textarea class="form-control" name="description" rows="2">${zone?.description || ''}</textarea>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="daily_rare_fish_quota" class="form-label">稀有鱼每日配额</label>
                        <input type="number" class="form-control" name="daily_rare_fish_quota" value="${zone?.daily_rare_fish_quota || 0}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="fishing_cost" class="form-label">钓鱼消耗 (金币)</label>
                        <input type="number" class="form-control" name="fishing_cost" value="${zone?.fishing_cost || 10}" min="1">
                    </div>
                    <div class="col-md-4 mb-3 d-flex align-items-end">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" ${zone?.is_active ?? true ? 'checked' : ''}>
                            <label class="form-check-label ms-2" for="is_active">启用区域</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="available_from" class="form-label">开放时间 (可选)</label>
                        <input type="datetime-local" class="form-control" name="available_from" value="${zone?.available_from || ''}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label for="available_until" class="form-label mb-0">结束时间 (可选)</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="limit_time" id="limit_time" ${zone?.available_from || zone?.available_until ? 'checked' : ''}>
                                <label class="form-check-label" for="limit_time">限定开放时间</label>
                            </div>
                        </div>
                        <input type="datetime-local" class="form-control mt-2" name="available_until" value="${zone?.available_until || ''}">
                    </div>
                </div>
                <div class="mb-3">
                    <label>稀有度分布 (概率总和应为 1)</label>
                    <div class="row">
                        ${[...Array(5).keys()].map(i => `
                            <div class="col-md-2 col-4 mb-2">
                                <label>${i+1} 星</label>
                                <input type="number" step="0.001" min="0" max="1" class="form-control rarity-input" name="rarity_${i+1}" value="${rarityDistribution[i]}" placeholder="0.000">
                            </div>
                        `).join('')}
                        <div class="col-md-2 col-4 mb-2">
                            <label>6+ 星</label>
                            <input type="number" step="0.001" min="0" max="1" class="form-control rarity-input" name="rarity_6plus" value="${rarityDistribution[5]}" placeholder="0.000">
                        </div>
                    </div>
                    <div id="rarity-sum-feedback" class="form-text mt-1"></div>
                    <small class="text-muted">提示：6+星包含所有6星及以上稀有度，中奖后随机从高星鱼池选择。</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">限定鱼类选择 (不选则为全局鱼池)</label>
                    
                    <!-- 搜索和过滤控件 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" id="fishSearch" placeholder="搜索鱼类名称..." onkeyup="filterFishOptions()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control form-control-sm" id="rarityFilter" onchange="filterFishOptions()">
                                <option value="">所有稀有度</option>
                                <option value="1">★ 1星</option>
                                <option value="2">★★ 2星</option>
                                <option value="3">★★★ 3星</option>
                                <option value="4">★★★★ 4星</option>
                                <option value="5">★★★★★ 5星</option>
                                <option value="6">★★★★★★ 6星</option>
                                <option value="7">★★★★★★★ 7星</option>
                                <option value="8">★★★★★★★★ 8星</option>
                                <option value="9">★★★★★★★★★ 9星</option>
                                <option value="10">★★★★★★★★★★ 10星</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success" onclick="addSelectedFish()">
                                    <i class="fas fa-plus"></i> 添加选中
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="removeSelectedFish()">
                                    <i class="fas fa-minus"></i> 移除选中
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 双框选择器 -->
                    <div class="row">
                        <!-- 总鱼池 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">总鱼池</h6>
                                    <small class="text-muted" id="totalFishCount">0 种鱼类</small>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="totalFishList" style="max-height: 300px; overflow-y: auto;">
                                        ${totalFishListHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 选择池 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">已选择鱼类</h6>
                                    <div>
                                        <small class="text-muted me-2">
                                            <span id="selectedCount">0</span> 种 | 
                                            总价值: <span id="totalValue">0</span>
                                        </small>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllSelected()">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="selectedFishList" style="max-height: 300px; overflow-y: auto;">
                                        <div class="list-group-item text-muted text-center" id="emptySelectedMessage">
                                            暂无选择，双击左侧鱼类添加到选择池
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 隐藏的输入框用于表单提交 -->
                    <input type="hidden" name="specific_fish_ids" id="specific_fish_ids_input">
                </div>
                <div class="mb-3">
                    <label class="form-label">通行证要求</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="requires_pass" 
                                       id="requires_pass" ${zone?.requires_pass ? 'checked' : ''}>
                                <label class="form-check-label" for="requires_pass">需要通行证</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <select class="form-control" name="required_item_id" ${!zone?.requires_pass ? 'disabled' : ''}>
                                <option value="">选择通行证道具</option>
                                ${allItemsData.map(item => `
                                    <option value="${item.item_id}" ${zone?.required_item_id == item.item_id ? 'selected' : ''}>
                                        ${item.name} (ID: ${item.item_id})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="submit" class="btn btn-primary">${isEdit ? '更新' : '创建'}</button>
                </div>
            </form>
        `;
    }

    // Populate create form
    document.getElementById('createZoneModal').querySelector('.modal-body').innerHTML = renderForm();

    const createFormEl = document.getElementById('create-zone-form');
    hookLimitedTimeToggle(createFormEl);

    createFormEl.addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const errorAlert = form.querySelector('#form-error-alert');
        errorAlert.classList.add('d-none'); // Hide previous errors
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        data.id = parseInt(data.id);
        data.daily_rare_fish_quota = parseInt(data.daily_rare_fish_quota);
        data.fishing_cost = parseInt(data.fishing_cost) || 10;
        data.is_active = data.is_active === 'on';
        const limitTime = form.querySelector('input[name="limit_time"]').checked;
        if (!limitTime) {
            data.available_from = '';
            data.available_until = '';
        }
        // 计算稀有度和（支持1-5星 + 6+星）
        const rarityDistribution = [
            ...([...Array(5).keys()].map(i => parseFloat(data[`rarity_${i+1}`]) || 0)),
            parseFloat(data['rarity_6plus']) || 0
        ];
        const sum = rarityDistribution.reduce((a,b)=>a+b,0);
        if (Math.abs(sum - 1.0) > 1e-4) {
            showFormError(form, '稀有度分布总和必须为 1');
            return;
        }
        data.configs = { rarity_distribution: rarityDistribution };
            data.specific_fish_ids = this.querySelector('input[name="specific_fish_ids"]').value.split(',').filter(id => id).map(id => parseInt(id));
        
        // 处理通行证要求
        data.requires_pass = data.requires_pass === 'on';
        if (data.requires_pass && data.required_item_id) {
            data.required_item_id = parseInt(data.required_item_id);
        } else {
            data.required_item_id = null;
        }
        
        const response = await fetch('/admin/api/zones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });
        const result = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            showFormError(form, result.message, result.errors);
        }
    });

    document.body.addEventListener('input', function(e) {
        if (e.target.classList.contains('rarity-input')) {
            const form = e.target.closest('form');
            if (form) {
                const rarityInputs = form.querySelectorAll('.rarity-input');
                const sum = Array.from(rarityInputs).reduce((acc, input) => acc + (parseFloat(input.value) || 0), 0);
                const feedbackEl = form.querySelector('#rarity-sum-feedback');
                feedbackEl.textContent = `当前总和: ${sum.toFixed(4)}`;
                if (Math.abs(sum - 1.0) > 1e-4) {
                    feedbackEl.classList.add('text-danger');
                } else {
                    feedbackEl.classList.remove('text-danger');
                }
            }
        }
        
        // 处理通行证选择
        if (e.target.name === 'requires_pass') {
            const itemSelect = e.target.closest('form').querySelector('select[name="required_item_id"]');
            if (e.target.checked) {
                itemSelect.disabled = false;
            } else {
                itemSelect.disabled = true;
                itemSelect.value = '';
            }
        }
    });

    function showFormError(form, message, errors = null) {
        const errorAlert = form.querySelector('#form-error-alert');
        let html = `<strong>${message}</strong>`;
        if (errors) {
            html += '<ul>';
            for (const key in errors) {
                html += `<li>${errors[key]}</li>`;
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.classList.add('is-invalid');
                }
            }
            html += '</ul>';
        }
        errorAlert.innerHTML = html;
        errorAlert.classList.remove('d-none');
        // Remove 'is-invalid' class on input change
        form.querySelectorAll('.is-invalid').forEach(input => {
            input.addEventListener('input', () => input.classList.remove('is-invalid'), { once: true });
        });
    }

    function openEditModal(zoneId) {
        const zone = getZoneById(zoneId);
        document.getElementById('editZoneModalBody').innerHTML = renderForm(zone);
        
        // 初始化已选择的鱼类
        initializeSelectedFish(zone?.specific_fish_ids || []);
        
        new bootstrap.Modal(document.getElementById('editZoneModal')).show();

        const editForm = document.getElementById('edit-zone-form');
        hookLimitedTimeToggle(editForm);

        editForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const errorAlert = form.querySelector('#form-error-alert');
            errorAlert.classList.add('d-none'); // Hide previous errors

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            data.id = parseInt(data.id);
            data.daily_rare_fish_quota = parseInt(data.daily_rare_fish_quota);
            data.fishing_cost = parseInt(data.fishing_cost) || 10;
            data.is_active = data.is_active === 'on';
            const limitTime = form.querySelector('input[name="limit_time"]').checked;
            if (!limitTime) {
                data.available_from = '';
                data.available_until = '';
            }
            const rarityDistribution = [
                ...([...Array(5).keys()].map(i => parseFloat(data[`rarity_${i+1}`]) || 0)),
                parseFloat(data['rarity_6plus']) || 0
            ];
            const sum = rarityDistribution.reduce((a,b)=>a+b,0);
            if (Math.abs(sum - 1.0) > 1e-4) {
                showFormError(form, '稀有度分布总和必须为 1');
                return;
            }
            data.configs = { rarity_distribution: rarityDistribution };
            data.specific_fish_ids = this.querySelector('input[name="specific_fish_ids"]').value.split(',').filter(id => id).map(id => parseInt(id));
            
            // 处理通行证要求
            data.requires_pass = data.requires_pass === 'on';
            if (data.requires_pass && data.required_item_id) {
                data.required_item_id = parseInt(data.required_item_id);
            } else {
                data.required_item_id = null;
            }

            const response = await fetch(`/admin/api/zones/${zoneId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
                location.reload();
            } else {
                showFormError(form, result.message, result.errors);
            }
        });
    }

    async function deleteZone(zoneId) {
        if (confirm('确定要删除这个区域吗？')) {
            const response = await fetch(`/admin/api/zones/${zoneId}`, {
                method: 'DELETE',
            });
            const result = await response.json();
            if (result.success) {
                document.getElementById(`zone-card-${zoneId}`).remove();
            } else {
                alert('删除失败: ' + result.message);
            }
        }
    }

    function hookLimitedTimeToggle(form) {
        const toggle = form.querySelector('input[name="limit_time"]');
        const fromInput = form.querySelector('input[name="available_from"]');
        const untilInput = form.querySelector('input[name="available_until"]');
        const applyState = () => {
            const enabled = toggle && toggle.checked;
            [fromInput, untilInput].forEach(el => {
                if (!el) return;
                el.disabled = !enabled;
                if (!enabled) el.value = '';
            });
        };
        if (toggle) {
            applyState();
            toggle.addEventListener('change', applyState);
        }
    }

    // 双框鱼类选择功能
    let selectedFishIds = new Set();
    
    function filterFishOptions() {
        const searchTerm = document.getElementById('fishSearch').value.toLowerCase();
        const rarityFilter = document.getElementById('rarityFilter').value;
        const fishItems = document.querySelectorAll('#totalFishList .fish-item');
        
        fishItems.forEach(item => {
            const fishName = item.getAttribute('data-name').toLowerCase();
            const fishRarity = item.getAttribute('data-rarity');
            
            const matchesSearch = !searchTerm || fishName.includes(searchTerm);
            const matchesRarity = !rarityFilter || fishRarity === rarityFilter;
            
            if (matchesSearch && matchesRarity) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        
        updateTotalFishCount();
    }
    
    function toggleFishSelection(element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        
        // 更新对应星级的全选状态
        updateRarityCheckboxState(element);
    }
    
    function updateRarityCheckboxState(fishElement) {
        const rarity = fishElement.getAttribute('data-rarity');
        const rarityCheckbox = document.getElementById(`rarity-${rarity}`);
        if (!rarityCheckbox) return;
        
        // 找到该星级的所有可见鱼类
        const fishItems = document.querySelectorAll(`#totalFishList .fish-item[data-rarity="${rarity}"]:not([style*="display: none"])`);
        const checkedItems = document.querySelectorAll(`#totalFishList .fish-item[data-rarity="${rarity}"]:not([style*="display: none"]) input[type="checkbox"]:checked`);
        
        // 如果所有鱼类都被选中，则选中星级勾选框；否则取消选中
        rarityCheckbox.checked = fishItems.length > 0 && checkedItems.length === fishItems.length;
    }
    
    function addFishToSelected(fishId) {
        if (selectedFishIds.has(fishId)) return;
        
        const fishItem = document.querySelector(`[data-fish-id="${fishId}"]`);
        if (!fishItem) return;
        
        selectedFishIds.add(fishId);
        fishItem.classList.add('d-none');
        
        // 添加到选择池
        addFishToSelectedList(fishItem);
        updateSelectedStats();
        updateHiddenInput();
    }
    
    function addSelectedFish() {
        const checkedItems = document.querySelectorAll('#totalFishList .fish-item input[type="checkbox"]:checked');
        checkedItems.forEach(checkbox => {
            const fishId = parseInt(checkbox.value);
            addFishToSelected(fishId);
        });
    }
    
    function removeSelectedFish() {
        const checkedItems = document.querySelectorAll('#selectedFishList .fish-item input[type="checkbox"]:checked');
        checkedItems.forEach(checkbox => {
            const fishId = parseInt(checkbox.value);
            removeFishFromSelected(fishId);
        });
    }
    
    function removeFishFromSelected(fishId) {
        if (!selectedFishIds.has(fishId)) return;
        
        selectedFishIds.delete(fishId);
        
        // 从选择池移除
        const selectedItem = document.querySelector(`#selectedFishList [data-fish-id="${fishId}"]`);
        if (selectedItem) {
            selectedItem.remove();
        }
        
        // 显示在总鱼池中
        const totalItem = document.querySelector(`#totalFishList [data-fish-id="${fishId}"]`);
        if (totalItem) {
            totalItem.classList.remove('d-none');
            totalItem.querySelector('input[type="checkbox"]').checked = false;
        }
        
        updateSelectedStats();
        updateHiddenInput();
    }
    
    function addFishToSelectedList(fishItem) {
        const fishId = parseInt(fishItem.getAttribute('data-fish-id'));
        const fishName = fishItem.getAttribute('data-name');
        const fishRarity = parseInt(fishItem.getAttribute('data-rarity'));
        const fishValue = parseInt(fishItem.getAttribute('data-value'));
        
        const rarityStars = '★'.repeat(fishRarity);
        const value = fishValue.toLocaleString();
        
        const selectedList = document.getElementById('selectedFishList');
        const emptyMessage = document.getElementById('emptySelectedMessage');
        
        if (emptyMessage) {
            emptyMessage.style.display = 'none';
        }
        
        const fishElement = document.createElement('div');
        fishElement.className = 'list-group-item fish-item';
        fishElement.setAttribute('data-fish-id', fishId);
        fishElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${fishName}</strong>
                    <br><small class="text-muted">${rarityStars} 价值: ${value} 金币</small>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${fishId}">
                </div>
            </div>
        `;
        
        fishElement.onclick = function() {
            toggleFishSelection(this);
        };
        
        selectedList.appendChild(fishElement);
    }
    
    function clearAllSelected() {
        selectedFishIds.clear();
        
        // 清空选择池
        const selectedList = document.getElementById('selectedFishList');
        selectedList.innerHTML = '<div class="list-group-item text-muted text-center" id="emptySelectedMessage">暂无选择，双击左侧鱼类添加到选择池</div>';
        
        // 显示所有总鱼池项目
        const totalItems = document.querySelectorAll('#totalFishList .fish-item');
        totalItems.forEach(item => {
            item.classList.remove('d-none');
            item.querySelector('input[type="checkbox"]').checked = false;
        });
        
        updateSelectedStats();
        updateHiddenInput();
    }
    
    function toggleRaritySelection(rarity) {
        // 找到指定稀有度的所有可见鱼类
        const fishItems = document.querySelectorAll(`#totalFishList .fish-item[data-rarity="${rarity}"]:not([style*="display: none"])`);
        const rarityCheckbox = document.getElementById(`rarity-${rarity}`);
        
        if (fishItems.length === 0) {
            rarityCheckbox.checked = false;
            return;
        }
        
        // 根据星级勾选框状态，设置所有该星级鱼类的勾选状态
        const isChecked = rarityCheckbox.checked;
        fishItems.forEach(item => {
            const checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.checked = isChecked;
        });
        
        // 显示成功消息
        const rarityStars = '★'.repeat(rarity);
        const count = fishItems.length;
        const action = isChecked ? '选中' : '取消选中';
        showTemporaryMessage(`已${action} ${count} 种 ${rarityStars} ${rarity}星鱼类`, 'info');
    }
    
    function showTemporaryMessage(message, type = 'info') {
        // 创建临时消息提示
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 3秒后自动消失
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    function updateTotalFishCount() {
        const visibleItems = document.querySelectorAll('#totalFishList .fish-item:not([style*="display: none"])');
        document.getElementById('totalFishCount').textContent = `${visibleItems.length} 种鱼类`;
    }
    
    function updateSelectedStats() {
        const selectedCount = selectedFishIds.size;
        const selectedItems = document.querySelectorAll('#selectedFishList .fish-item');
        const totalValue = Array.from(selectedItems).reduce((sum, item) => {
            return sum + (parseInt(item.getAttribute('data-value')) || 0);
        }, 0);
        
        document.getElementById('selectedCount').textContent = selectedCount;
        document.getElementById('totalValue').textContent = totalValue.toLocaleString();
    }
    
    function updateHiddenInput() {
        const hiddenInput = document.getElementById('specific_fish_ids_input');
        hiddenInput.value = Array.from(selectedFishIds).join(',');
    }
    
    function initializeSelectedFish(specificFishIds) {
        // 清空当前选择
        selectedFishIds.clear();
        
        // 清空选择池
        const selectedList = document.getElementById('selectedFishList');
        if (selectedList) {
            selectedList.innerHTML = '<div class="list-group-item text-muted text-center" id="emptySelectedMessage">暂无选择，双击左侧鱼类添加到选择池</div>';
        }
        
        // 显示所有总鱼池项目
        const totalItems = document.querySelectorAll('#totalFishList .fish-item');
        totalItems.forEach(item => {
            item.classList.remove('d-none');
            item.querySelector('input[type="checkbox"]').checked = false;
        });
        
        // 取消所有星级勾选框
        const rarityCheckboxes = document.querySelectorAll('input[id^="rarity-"]');
        rarityCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // 添加已选择的鱼类
        specificFishIds.forEach(fishId => {
            const fishItem = document.querySelector(`[data-fish-id="${fishId}"]`);
            if (fishItem) {
                addFishToSelected(fishId);
            }
        });
        
        updateSelectedStats();
        updateHiddenInput();
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        updateTotalFishCount();
        updateSelectedStats();
    });
</script>
{% endblock %}
