![:astrbot_plugin_fish](https://count.getloli.com/@:astrbot_plugin_fish?theme=capoo-1)

# AstrBot 钓鱼插件

一个功能齐全的钓鱼游戏系统插件，为您的机器人添加有趣的钓鱼休闲游戏。

## 💡Future

如果你有什么想法，欢迎提交issue！期待您天马行空的想法

## 🤝TODO

- [ ] 分离成就模块，以便于未来拓展
- [ ] 丰富图鉴类命令
- [ ] 将部分输出结果改写成输出图片
- [ ] 钓鱼区域功能扩展
- [ ] 更多经济系统
- [ ] 重构商店系统
- [x] 扩展背包，增加道具栏
- [ ] 更多社交玩法
 
## 📦 更新记录

#### v1.6.4

- **新增道具**：
  - **守护海灵**：使用后4小时内鱼塘免受偷窃。
  - **时运沙漏**：可占卜下一次擦弹的运势。
- **擦弹玩法重大升级**：
  - 占卜结果采用“御神籤”风格，分为「大吉、中吉、吉、小吉、凶、大凶」六档。
  - 占卜结果将**锁定**下一次擦弹的奖励倍率到对应区间，极大增强了策略性。
  - 重置擦弹概率模型，引入了`0.0~0.1`倍（大凶）和`15.0~1000.0`倍（大吉）的极低概率区间，让结果更具戏剧性。
- **机制优化**：
  - `/偷鱼` 指令现在会检查目标用户是否处于「守护海灵」的保护状态下。

#### v1.6.3

- 新增三档精炼护符（不可直接使用，精炼毁坏时自动消耗）：
  - 破厄护符·守（4★）：5星及以下装备，毁坏改为普通失败，本体保留且不降级。
  - 破厄护符·折（4★）：毁坏触发时降1级并保留本体。
  - 天命护符·神佑（5★）：毁坏必改为普通失败，本体保留且不降级。
- 精炼毁坏分支支持自动识别并优先消耗 keep 类护符，其次消耗 downgrade 类护符；若均无则按原逻辑处理。
- 管理命令精简：将“管理员 同步道具”简化为“同步道具”（仍需管理员权限）。
- 帮助图片与命令手册新增“/同步道具”说明。

#### v1.6.2

- 出售定价重构：鱼竿与饰品的系统回收价 = 基础价(按稀有度) × 精炼等级乘数。
- 支持通过配置项 `sell_prices` 精细化控制不同稀有度的基础价与各精炼等级的乘数。
- 批量出售（出售所有鱼竿/饰品）同样按新规则逐件计价，并跳过正在装备的物品。

#### v1.6.1 (AI代码审计重构)

- **代码质量提升**: 根据AI代码审计报告，对插件进行了全面的重构。
- **性能优化**: 修复了多处阻塞事件循环的同步操作，包括文件IO、网络请求和子进程调用，全部改造为异步实现，显著提升插件在高并发场景下的性能和响应速度。
- **健壮性增强**: 修复了潜在的逻辑bug（如图鉴进度计算错误），收紧了异常捕获的范围，避免隐藏潜在错误。
- **路径管理优化**: 将所有硬编码的文件路径（数据库、临时文件、头像缓存）替换为由框架动态生成的数据目录，增强了插件的可移植性和规范性。
- **安全加固**: 移除了后台管理的硬编码默认密钥，避免了安全隐患。
- **代码去重**: 将绘图模块中重复的辅助函数提取到共享的`utils.py`中，提高了代码的可维护性。

#### v1.4.6 - v.1.6.0

- 扩展了高级货币/钻石/星石功能
- 增加了道具系统，现在你有更多机会偷鱼和擦弹！
- 新增了每日免费一抽，签到自动抽取
- 新增了背包功能，使用/背包来查看所有物品
- 更好的精炼系统，新增了耐久和毁坏机制。使用/精炼命令来查看新特性
- 新增了后台管理界面CSV批量导入鱼竿和饰品
- 后台管理功能增加了用户管理功能
- 后台管理功能增加了市场管理功能
- 补充了管理员命令 `/代理上线` 和 `/代理下线`。
- 新增了很多命令的别名
- 更好的卡池管理系统，支持高级货币和限时卡池
- 修复了鱼竿的数量加成没有生效的BUG。

#### v1.4.0 - v1.4.6

- 将一些配置移动到了插件管理的插件配置中，进一步丰富了自定义内容
- 把`出售所有鱼竿`和`出售所有饰品`的逻辑修改为：一键出售所有非五星和未装备的鱼竿或饰品
- 新增`精炼鱼竿 [ID]`和`精炼饰品 [ID]`命令，每提升一级基础加成额外加成10%，若精5则再加成10%即最高50%加成
- 将`钓鱼帮助`命令的输出结果改为图片，方便用户查看
- 修复了时效鱼饵过期后不会自动删除的问题
- 修复鱼饵库存没有了任然使用的bug
- 修复出售所有鱼竿和饰品的时候不卖出五星但任然得到五星钱的bug
- 修复上架市场会导致精炼等级为1的bug，优化市场输出（增加精炼等级）
- 修复无法购买高精的物品bug

## ✨ 功能特点

- 支持导入1.0数据
- 完整的钓鱼游戏系统
- 多种鱼类和稀有度
- 钓鱼装备系统（鱼竿、鱼饵）
- 商店系统
- 抽卡系统
- 排行榜
- 每日签到
- 成就和称号系统
- 金币经济系统
- 后台管理系统（自定义游戏数据！）

![image](https://github.com/user-attachments/assets/4dd1a179-967f-4cb9-82a5-ca3754b80bb0)
![image](https://github.com/user-attachments/assets/c80550e6-86a2-4373-b593-a7e2a8d0ab6b)
![image](https://github.com/user-attachments/assets/b7fd24bc-c0fe-4cee-9431-41b38af665e6)

## 🎣 钓鱼游戏命令手册 🎣

提示：命令中的 [ID] 表示必填参数，<> 表示可选参数。

### 🎣 基础与核心玩法

| 命令 | 描述 |
|---|---|
| `/注册` | 注册新用户 |
| `/钓鱼` | 进行一次钓鱼 |
| `/签到` | 每日签到 |
| `/自动钓鱼` | 开启/关闭自动钓鱼 |
| `/钓鱼区域 [ID]` | 查看或切换钓鱼区域 |
| `/钓鱼记录` | 查看最近钓鱼记录 |

### 🎒 背包与资产管理

| 命令 | 描述 |
|---|---|
| `/状态` | 查看个人详细状态 |
| `/背包` | 查看我的所有物品 |
| `/鱼塘` | 查看鱼塘中的所有鱼 |
| `/鱼塘容量` | 查看当前鱼塘容量 |
| `/升级鱼塘` | 升级鱼塘容量 |
| `/鱼竿` | 查看我的鱼竿 |
| `/鱼饵` | 查看我的鱼饵 |
| `/饰品` | 查看我的饰品 |
| `/道具` | 查看我的道具 |
| `/使用 [ID]` | 使用指定ID的道具 |
| `/卖道具 [ID] [数量]` | 出售指定ID和数量的道具 |
| `/使用鱼竿 [ID]` | 装备指定ID鱼竿 |
| `/使用鱼饵 [ID]` | 使用指定ID鱼饵 |
| `/使用饰品 [ID]` | 装备指定ID饰品 |
| `/精炼鱼竿 [ID]` | 精炼指定ID鱼竿 |
| `/精炼饰品 [ID]` | 精炼指定ID饰品 |
| `/精炼帮助` | 查看精炼系统详细说明 |
| `/金币` | 查看金币余额 |
| `/高级货币` | 查看高级货币余额 |

### 🛒 商店与市场

| 命令 | 描述 |
|---|---|
| `/全部卖出` | 一键卖出鱼塘所有鱼 |
| `/保留卖出` | 卖出所有鱼但每种保留一条 |
| `/出售稀有度 [1-5]` | 卖出指定稀有度的鱼 |
| `/出售鱼竿 [ID]` | 出售指定ID鱼竿（按稀有度×精炼等级计价） |
| `/出售所有鱼竿` | 一键出售所有(非在用/非保护)鱼竿（逐件按新规则计价） |
| `/出售饰品 [ID]` | 出售指定ID饰品（按稀有度×精炼等级计价） |
| `/出售所有饰品` | 一键出售所有(非在用/非保护)饰品（逐件按新规则计价） |
| `/商店` | 查看官方商店 |
| `/购买鱼竿 [ID]` | 从商店购买鱼竿 |
| `/购买鱼饵 [ID]` | 从商店购买鱼饵 |
| `/市场` | 查看玩家交易市场 |
| `/上架鱼竿 [ID] [价格]` | 将鱼竿上架市场 |
| `/上架饰品 [ID] [价格]` | 将饰品上架市场 |
| `/购买 [ID]` | 从市场购买商品 |
| `/我的上架` | 查看我上架的商品 |
| `/下架 [ID]` | 下架我的商品 |

### 💰 出售定价与配置（鱼竿/饰品）

- 系统回收价计算：`售价 = 基础价(按稀有度) × 精炼等级乘数`
- 适用范围：`/出售鱼竿`、`/出售饰品`、`/出售所有鱼竿`、`/出售所有饰品`
- 批量出售会跳过正在装备的物品

配置示例（位于插件运行时装配的 `game_config` 中）：

```json
{
  "sell_prices": {
    "rod": { "1": 100, "2": 500, "3": 2000, "4": 5000, "5": 10000 },
    "accessory": { "1": 100, "2": 500, "3": 2000, "4": 5000, "5": 10000 },
    "refine_multiplier": {
      "1": 1.0, "2": 1.6, "3": 3.0, "4": 6.0, "5": 12.0,
      "6": 25.0, "7": 55.0, "8": 125.0, "9": 280.0, "10": 660.0
    }
  }
}
```

- 你可以按需调整不同稀有度的基础价，或调整各精炼等级的乘数曲线（当前默认为递增、近指数型曲线，鼓励高精炼装备的投资回报）。
- 市场玩家间交易价格不受上述配置限制，由卖家自定。

### 🎰 抽卡与概率玩法

| 命令 | 描述 |
|---|---|
| `/抽卡 [卡池ID]` | 进行单次抽卡 |
| `/十连 [卡池ID]` | 进行十连抽卡 |
| `/查看卡池 [ID]` | 查看卡池详情 |
| `/抽卡记录` | 查看我的抽卡记录 |
| `/擦弹 [金额]` | 进行擦弹游戏 (可填allin/halfin) |
| `/擦弹记录` | 查看我的擦弹记录 |

### 👥 社交功能

| 命令 | 描述 |
|---|---|
| `/排行榜` | 查看金币排行榜 |
| `/偷鱼 [@用户]` | 偷取指定用户的一条鱼 |
| `/查看称号` | 查看我拥有的称号 |
| `/使用称号 [ID]` | 装备指定ID称号 |
| `/查看成就` | 查看我的成就进度 |
| `/税收记录` | 查看我的税收记录 |
| `/鱼类图鉴` | 查看已解锁的鱼类图鉴 |

### ⚙️ 管理后台（管理员）

| 命令 | 描述 |
|---|---|
| `/修改金币 [用户ID] [数量]` | 修改用户金币 |
| `/奖励金币 [用户ID] [数量]` | 奖励用户金币 |
| `/扣除金币 [用户ID] [数量]` | 扣除用户金币 |
| `/修改高级货币 [用户ID] [数量]` | 修改高级货币 |
| `/奖励高级货币 [用户ID] [数量]` | 奖励高级货币 |
| `/扣除高级货币 [用户ID] [数量]` | 扣除高级货币 |
| `/全体奖励金币 [数量]` | 给所有用户发放金币 |
| `/全体奖励高级货币 [数量]` | 给所有用户发放高级货币 |
| `/全体扣除金币 [数量]` | 从所有用户扣除金币 |
| `/全体扣除高级货币 [数量]` | 从所有用户扣除高级货币 |
| `/开启钓鱼后台管理` | 启动Web管理后台 |
| `/关闭钓鱼后台管理` | 关闭Web管理后台 |
| `/同步道具` | 从 initial_data.py 同步道具模板（管理员） |
| `/代理上线 [用户ID]` | 扮演指定用户 |
| `/代理下线` | 结束扮演 |

## 🔧 安装方法

1. 将此插件放入 `data/plugins/`